<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>لوحة تحكم الآغا برو</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'IBM Plex Sans Arabic', sans-serif; background: #f0f4f8; padding: 20px; }
  .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
  h2 { color: #0062ff; text-align: center; }
  label { display: block; margin: 15px 0 5px; font-weight: bold; }
  input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
  .btn-save { background: #0062ff; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; margin-top: 20px; cursor: pointer; font-weight: bold; }
  .admin-row { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid #eee; }
  .btn-edit { background: #34d399; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: 5px; }
  .btn-delete { background: #f87171; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
</style>
</head>
<body>

<div class="container">
  <h2>لوحة إدارة البيانات</h2>
  
  <label>الشركة:</label>
  <select id="adminBrand"></select>
  
  <label>اسم الجهاز (الموديل):</label>
  <input type="text" id="adminName" placeholder="مثلاً: iPhone 13">
  
  <label>الموديلات المتوافقة:</label>
  <input type="text" id="adminPrice" placeholder="مثلاً: iPhone 14, 15">
  
  <label>القسم:</label>
  <select id="adminType"></select>
  
  <button class="btn-save" onclick="addItem()">حفظ البيانات</button>

  <hr style="margin-top: 40px;">
  <h3>البحث والتعديل</h3>
  <input type="text" id="adminSearch" oninput="renderAdminList()" placeholder="ابحث لتعديل أو حذف...">
  <div id="adminDataList"></div>
</div>

<script>
  // رابط Google Apps Script الخاص بك
  const apiUrl = "https://script.google.com/macros/s/AKfycbzG8ppzM1qIVFSjUp7FfRMYL9vQbH1cIgHUceaIDQgK1yh7Pir_rbFHYREJ8Qgl3ONDvA/exec";
  let allData = [];
  const DB_BRANDS = ["ايفون", "سامسونج", "شاومي", "هواوي", "هونر", "اوبو", "فيفو", "انفنكس", "تكنو", "ريلمي", "آيتل"];
  const DB_TYPES = ["شاشات", "بطاريات", "فلاتات شحن", "ايسيات", "لواصق", "شرائط"];

  window.onload = function() {
    fillSelect('adminBrand', DB_BRANDS);
    fillSelect('adminType', DB_TYPES);
    fetchData();
  };

  function fillSelect(id, list) {
    const el = document.getElementById(id);
    list.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item; opt.innerText = item; el.appendChild(opt);
    });
  }

  async function fetchData() {
    try {
      const res = await fetch(apiUrl);
      allData = await res.json();
      renderAdminList();
    } catch (e) { console.error("Error fetching data:", e); }
  }

  async function addItem() {
    const brand = document.getElementById('adminBrand').value;
    const name = document.getElementById('adminName').value;
    const compat = document.getElementById('adminPrice').value;
    const type = document.getElementById('adminType').value;
    
    if (!name || !compat) { 
      alert('يرجى ملء كافة الحقول'); 
      return; 
    }
    
    // إرسال البيانات للسكربت
    await fetch(apiUrl, { 
      method: 'POST', 
      mode: 'no-cors', 
      body: JSON.stringify({ name, compat, type, brand, action: "add" }) 
    });
    
    alert('تمت الإضافة بنجاح');
    
    // إفراغ الخانات تلقائياً للإضافة الجديدة
    document.getElementById('adminName').value = '';
    document.getElementById('adminPrice').value = '';
    
    // تحديث القائمة بالأسفل
    fetchData();
  }

  function renderAdminList() {
    const query = document.getElementById('adminSearch').value.toLowerCase();
    const list = document.getElementById('adminDataList');
    list.innerHTML = '';
    
    if (allData.length > 1) {
      allData.slice(1).forEach((row, index) => {
        if (row[0].toString().toLowerCase().includes(query) || row[3].toString().toLowerCase().includes(query)) {
          const div = document.createElement('div');
          div.className = 'admin-row';
          div.innerHTML = `
            <span><strong>${row[0]}</strong> (${row[3]})</span>
            <div>
              <button class="btn-edit" onclick="editItem(${index + 1})">تعديل</button>
              <button class="btn-delete" onclick="deleteItem(${index + 1})">حذف</button>
            </div>
          `;
          list.appendChild(div);
        }
      });
    }
  }

  async function editItem(index) {
    const row = allData[index];
    const newCompat = prompt(`تعديل التوافق لـ ${row[0]}:`, row[1]);
    if (newCompat === null || newCompat === "") return;
    
    await fetch(apiUrl, { 
      method: 'POST', 
      mode: 'no-cors', 
      body: JSON.stringify({ name: row[0], compat: newCompat, type: row[2], brand: row[3], action: "edit" }) 
    });
    
    alert('تم التعديل');
    fetchData();
  }

  async function deleteItem(index) {
    const row = allData[index];
    if (!confirm('هل أنت متأكد من حذف ' + row[0] + '؟')) return;
    
    await fetch(apiUrl, { 
      method: 'POST', 
      mode: 'no-cors', 
      body: JSON.stringify({ name: row[0], action: "delete" }) 
    });
    
    alert('تم الحذف');
    fetchData();
  }
</script>
</body>
</html>